version: "3.8"

services:
  database-service:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver-db
    ports:
      - "1433:1433"
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=YourStrong!Passw0rd
    volumes:
      - mssql_data:/var/opt/mssql
    networks:
      - app-network

  discovery-service:
    build:
      context: ./discovery
      dockerfile: Dockerfile
    container_name: discovery-service
    ports:
      - "8761:8761"
    networks:
      - app-network

  image-service:
    build:
      context: ./image
      dockerfile: Dockerfile
    container_name: image-service
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
    ports:
      - "8000:8000"
    volumes:
      - ./uploads:/app/uploads
    networks:
      - app-network

  gateway-service:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: gateway-service
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
    ports:
      - "8080:8080"
    networks:
      - app-network

  product-service:
    build:
      context: ./product
      dockerfile: Dockerfile
    container_name: product-service
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - DB_URL=r2dbc:mssql://database-service:1433/product
    ports:
      - "9000:9000"
    networks:
      - app-network

  order-service:
    build:
      context: ./order
      dockerfile: Dockerfile
    container_name: order-service
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - DB_URL=jdbc:sqlserver://database-service:1433;databaseName=order;encrypt=true;trustServerCertificate=true
      # Cấu hình Kafka bootstrap servers - sử dụng tên container
      - KAFKA_BOOTSTRAP_SERVERS=kafka-1:9092
    ports:
      - "9003:9003"
    depends_on:
      - kafka-1
      - database-service
    networks:
      - app-network
    restart: unless-stopped 

  promotion-service:
    build:
      context: ./promotion
      dockerfile: Dockerfile
    container_name: promotion-service
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - DB_URL=jdbc:sqlserver://database-service:1433;databaseName=promotion;encrypt=true;trustServerCertificate=true
      # Cấu hình Kafka bootstrap servers - sử dụng tên container
      - KAFKA_BOOTSTRAP_SERVERS=kafka-1:9092
    ports:
      - "12000:12000"
    depends_on:
      - kafka-1
      - database-service
    networks:
      - app-network
    restart: unless-stopped 

  user-service:
    build:
      context: ./user
      dockerfile: Dockerfile
    container_name: user-service
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - DB_URL=r2dbc:mssql://database-service:1433/user
      - PERMISSIONS=thongke,sanpham,kho,taikhoan,donhang,khachhang
      - ROOT_USERNAME=admin123
      - ROOT_PASSWORD=admin123
      - GOOGLE_AUTH_CLIENT_ID=client_id
      - GOOGLE_AUTH_CLIENT_SECRET=client_secret
      - GOOGLE_AUTH_REDIRECT_URL=http://localhost:4000/auth/google/callback
    ports:
      - "9002:9002"
    networks:
      - app-network
    depends_on:
      - database-service
    restart: unless-stopped 
   
  warehouse-service:
    build:
      context: ./warehouse
      dockerfile: Dockerfile
    container_name: warehouse-service
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - DB_URL=jdbc:sqlserver://database-service:1433;databaseName=warehouse;encrypt=true;trustServerCertificate=true
      - KAFKA_BOOTSTRAP_SERVERS=kafka-1:9092
    ports:
      - "9001:9001"
    depends_on:
      - kafka-1
      - database-service
    networks:
      - app-network
    restart: unless-stopped 

  # Kafka Service với cấu hình hỗ trợ cả internal (Docker) và external (localhost)
  kafka-1:
    image: confluentinc/cp-kafka:latest
    container_name: kafka-1
    ports:
      - "9092:9092"
      - "19092:19092"  # Port cho external connection từ host
    restart: "on-failure"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      # Listeners: INTERNAL cho Docker containers, EXTERNAL cho host machine
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:9092,EXTERNAL://0.0.0.0:19092,CONTROLLER://0.0.0.0:9093
      # INTERNAL advertise với kafka-1:9092 cho containers, EXTERNAL với localhost:19092 cho host
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka-1:9092,EXTERNAL://localhost:19092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
      # Đặt INTERNAL là listener mặc định cho inter-broker communication
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka-1:9093
      # Replication settings
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_LOG_DIRS: /tmp/kraft-combined-logs
      CLUSTER_ID: 'MkU3OEVBNTcwNTJENDM2Qk'
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server kafka-1:9092 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # Optional: Kafka UI để monitor
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8090:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=local
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka-1:9092
    depends_on:
      - kafka-1
    networks:
      - app-network
  
  qdrant-service:
    image: qdrant/qdrant:v1.11.2
    ports:
      - "6333:6333"   # REST API
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    restart: unless-stopped
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
      QDRANT__SERVICE__HTTP_PORT: 6333
    networks:
      - app-network

  chatbot-service:
    build:
      context: ./chat_bot
      dockerfile: Dockerfile
    container_name: chatbot-service
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - QDRANT_HOST=qdrant-service
      - QDRANT_PORT=6334
      - GEMINI_API_KEY=AIzaSyCTGNEA_TGJYrHPEG6Omr0m-GGuBbEeC1Y
    ports:
      - "10000:10000"
    networks:
      - app-network
    depends_on:
      - qdrant-service
    restart: unless-stopped 

  # recommend-service:
  #   build:
  #     context: ./recommend
  #     dockerfile: Dockerfile
  #   container_name: recommend-service
  #   environment:
  #     - GATEWAY_URL=http://gateway-service:8080
  #     - MSSQL_HOST=database-service
  #     - MSSQL_PORT=1433
  #     - MSSQL_DB=recommendation_system
  #     - MSSQL_USER=sa
  #     - MSSQL_PASSWORD=YourStrong!Passw0rd
  #     # gemini
  #     - GEMINI_SECRET_KEY=AIzaSyD9K93txU2gZ1b6yf-Q1cV3CjWFyVVV4pE
  #     - GEMINI_MODEL_NAME=models/text-embedding-004
  #     - QWEN_MODEL_NAME=Qwen/Qwen2.5-7B-Instruct
  #   ports:
  #     - "11000:11000"
  #   networks:
  #     - app-network
  #   restart: unless-stopped 

networks:
  app-network:
    driver: bridge

volumes:
  mssql_data:
  qdrant_data: